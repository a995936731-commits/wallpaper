# 七牛云部署指南

## ✅ 为什么选择七牛云？

1. **国内完全可访问**
   - ✅ 无需 VPN
   - ✅ CDN 加速
   - ✅ 速度快

2. **免费额度充足**
   - 10GB 存储空间
   - 10GB CDN 流量/月
   - 10 万次 PUT 请求/月
   - 100 万次 GET 请求/月

3. **需要**
   - ✅ 实名认证（身份证）
   - ❌ 不需要银行卡

---

## 📦 部署步骤

### 步骤 1：注册七牛云账号

1. 访问 [七牛云官网](https://www.qiniu.com/)
2. 点击 **注册**
3. 完成注册后，进行 **实名认证**

### 步骤 2：创建对象存储空间

1. 登录后，进入 [对象存储控制台](https://portal.qiniu.com/kodo/bucket)
2. 点击 **新建空间**
3. 填写信息：
   - **空间名称**：`wallpaper-gallery`（必须小写）
   - **存储区域**：选择离你最近的区域
   - **访问控制**：选择 **公开**
4. 点击 **确定创建**

### 步骤 3：绑定 CDN 域名

创建空间后，需要绑定一个 CDN 域名（七牛云会提供测试域名）：

1. 进入空间详情页
2. 找到 **CDN 加速域名**
3. 复制测试域名（格式：`http://xxxxx.bkt.clouddn.com`）
4. **保存这个域名**，稍后需要填入代码

### 步骤 4：获取 AccessKey 和 SecretKey

1. 点击右上角头像 → **密钥管理**
2. 你会看到：
   - **AccessKey** (AK)
   - **SecretKey** (SK)
3. **复制这两个密钥**

### 步骤 5：修改代码配置

1. 打开 `qiniu-sync.js` 文件
2. 找到第 8 行，修改 CDN 域名：
   ```javascript
   this.domain = 'http://xxxxx.bkt.clouddn.com'; // 替换为你的 CDN 域名
   ```

3. 保存文件

### 步骤 6：部署到 Vercel

1. 在 Vercel Dashboard > Settings > Environment Variables 添加环境变量：
   - `QINIU_ACCESS_KEY` = 你的 AccessKey
   - `QINIU_SECRET_KEY` = 你的 SecretKey
   - `QINIU_BUCKET` = `wallpaper-gallery`

2. 重新部署项目：
   ```bash
   cd /Users/mac137/wallpaper-gallery
   git add -A
   git commit -m "迁移到七牛云存储"
   vercel --prod
   ```

### 步骤 7：测试

1. 访问你的 Vercel 域名
2. 打开浏览器控制台（F12）
3. 上传一张测试图片
4. 查看控制台输出：
   ```
   ✅ 七牛云存储已启用（实时同步模式）
   🔄 正在上传文件到七牛云...
   ✅ 文件已上传到七牛云
   ✅ 元数据已同步到七牛云
   ```

5. 刷新页面，确认图片依然存在
6. 在七牛云控制台查看，应该能看到上传的文件

---

## 🔧 工作原理

```
┌─────────────────────────────────────────────────┐
│                  七牛云对象存储                    │
│                                                 │
│  ┌─────────────────────┐   ┌──────────────────┐│
│  │  wallpapers/        │   │  metadata.json   ││
│  │  ├─ 123.jpg        │   │                  ││
│  │  ├─ 456.mp4        │   │  { wallpapers: [ ││
│  │  └─ ...            │   │     { qiniuUrl } ││
│  │                     │   │  ] }             ││
│  └─────────────────────┘   └──────────────────┘│
└─────────────────────────────────────────────────┘
                      ↕
                 (CDN 加速)
                      ↕
┌─────────────────────────────────────────────────┐
│         浏览器 (前端直传 + IndexedDB 缓存)         │
└─────────────────────────────────────────────────┘
```

### 上传流程

1. 浏览器向后端 API 请求上传凭证（Token）
2. 后端使用 SecretKey 生成临时 Token 返回
3. 浏览器直接上传文件到七牛云（不经过后端）
4. 上传成功后，保存 CDN URL 到元数据

### 下载流程

1. 浏览器从七牛云下载 `metadata.json`
2. 读取所有壁纸的 CDN URL
3. 直接使用 CDN URL 显示图片（快速）
4. 后台同步到 IndexedDB（离线访问）

---

## 📊 免费额度监控

在七牛云控制台可以查看用量：

1. 进入 **对象存储控制台**
2. 查看 **用量统计**
3. 监控：
   - 存储空间（限制 10GB）
   - CDN 流量（限制 10GB/月）
   - API 请求次数

---

## 💡 使用建议

1. **图片优化** - 压缩到 < 5MB
2. **定期备份** - 使用"导出数据"功能
3. **监控用量** - 避免超出免费额度
4. **CDN 域名** - 可以绑定自己的域名

---

## ❓ 常见问题

**Q: CDN 域名是什么？**
A: 七牛云提供的 CDN 加速域名，格式类似 `http://xxxxx.bkt.clouddn.com`。测试域名有效期 30 天，之后需要绑定自己的域名。

**Q: 如何绑定自己的域名？**
A: 在空间设置中添加自定义域名，然后配置 CNAME 记录到七牛云。

**Q: 国内访问速度如何？**
A: 非常快！七牛云在国内有多个 CDN 节点，速度优于 Vercel 和 Cloudflare。

**Q: 数据安全吗？**
A: 七牛云是正规云服务商，数据安全有保障。但建议定期备份。

**Q: 超出免费额度怎么办？**
A: 七牛云会提示你充值或删除文件。建议定期清理不需要的壁纸。

---

## 🎊 部署完成

完成上述步骤后，你的壁纸收藏将拥有：

- ✅ **10GB 存储空间**
- ✅ **国内高速访问**（无需 VPN）
- ✅ **CDN 加速**
- ✅ **自动多端同步**
- ✅ **完全免费**（无需银行卡）

开始使用吧！🚀
